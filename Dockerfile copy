# Etapa 1: Construcción
FROM oven/bun:1 AS builder

# Establece el directorio de trabajo
WORKDIR /app

# Copia solo los archivos que no cambian con frecuencia (para cachear dependencias)
COPY ./frontend/bun.lock ./frontend/package.json ./frontend/vite.config.ts ./frontend/tsconfig.json ./

# Instala dependencias (esto se cachea mientras no cambie bun.lockb)
RUN bun install --frozen-lockfile

# Copia el resto de archivos (estos sí cambian seguido)
COPY ./frontend .
#COPY ./shared-types ../shared-types

# Construye el proyecto
RUN bun vite build

# Etapa 2: Imagen de producción liviana
FROM oven/bun:1 AS production

# Establece el directorio de trabajo
WORKDIR /app

# Copia los archivos generados en la etapa de construcción
COPY --from=builder /app/dist /app/dist

# Instala `serve` para servir los archivos estáticos
RUN bun add serve

# Exponer el puerto que usará el servidor
EXPOSE 5173

# Comando para iniciar el servidor estático
CMD ["serve", "-l", "5173", "./dist"]
